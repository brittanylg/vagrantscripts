 
# -*- mode: ruby -*-
# vi: set ft=ruby :

# requires vagrant-hostmanager

$logger = Log4r::Logger.new('vagrantfile')
def read_ip_address(machine)
    command =  "ip a | grep 'inet' | grep -v '127.0.0.1' | grep -v 'docker0' | cut -d: -f2 | awk '{ print $2 }' | cut -f1 -d\"/\""
    result  = ""

    $logger.info "Processing #{ machine.name } ... "

    begin
        # sudo is needed for ifconfig
        machine.communicate.sudo(command) do |type, data|
        result << data if type == :stdout
        end
        $logger.info "Processing #{ machine.name } ... success"
    rescue
        result = "# NOT-UP"
        $logger.info "Processing #{ machine.name } ... not running"
    end

    # the second inet is more accurate
    result.chomp.split("\n").last
end

Vagrant.configure("2") do |config|
    config.hostmanager.enabled = false
    config.hostmanager.manage_host = true
    config.hostmanager.ignore_private_ip = false
    config.hostmanager.include_offline = true

    cached_addresses = {}
    config.hostmanager.ip_resolver = proc do |vm, resolving_vm|
        read_ip_address(vm)
    end
    
    config.trigger.after [:up, :reload] do |trigger|
        trigger.run = {inline: "vagrant hostmanager"}
    end
end
